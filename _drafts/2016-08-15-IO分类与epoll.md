---
layout: post
title:  "IO分类与epoll"
date:    2016-08-15 20:50
categories: Net
comments: true
---

# 1 简介

最近在看Nginx，着实为它的超高并发能力所折服，感觉随着“物联网”的发展，接入的设备越来越多，Nginx发展潜力很大呀！

看的过程中也暴露了很多问题，比如IO就是其中之一，本篇就从IO分类说起，大致讨论一下Linux下IO多路复用的几种形式，
看一下为什么Nginx选择epoll作为IO

# 2 IO分类

 * 同步
 * 异步
 * 阻塞
 * 非阻塞

区别：

阻塞/非阻塞:这是对IO的调用端而言的，调用端如果调用之后挂起，直到结果返回，就是阻塞。否则就是非阻塞。
（好比烧水和炒菜，烧水时可以走开做其他的事，但是炒菜要一直看着，不能做其他的事。例子有点牵强，好尴尬⊙﹏⊙‖∣）

同步/异步:这是对数据的传递方式而言，如果数据是调用端自己去取，就是同步，如果是处理端送达，就是异步。
（好比下馆子打包和叫外卖，打包是自己把菜带回家，叫外卖是别人送过来的，哈哈,这个例子还不错吧！）

搭配：

一般情况下，异步与非阻塞搭配，同步和阻塞、非阻塞均有搭配，下面的的内容就是同步的实例。

# 3 select/poll/epoll 编程

## 3.1 优缺点及原理分析

select代码结构:
```
while true
{
   select()
   foreach(i in a[])
       handle a[i]
}
```
有3大缺点：
 
 * fd数目受限，在linux/posix_types.h头文件有这样的声明：#define __FD_SETSIZE 1024 
 * 每次select，都需要将fd数组整个拷贝到内核态
 * 每次处理都要遍历整个fd数组，及时存在大量不需要处理的事件

poll: 在select的基础上改进了，fd的数目有限的问题，FD上限是最大可以打开文件的数目，具体数目可以cat /proc/sys/fs/file-max来看。

epoll：epoll是event poll的缩写，在epoll的基础上继续改进,
epoll提供了三个函数:

```
epoll_create是创建一个epoll句柄；
epoll_ctl是注册要监听的事件类型；
epoll_wait则是等待事件的产生。
```
每次注册新的事件到epoll句柄中时，会把所有的fd拷贝进内核，保证了每个fd在整个过程中只会拷贝一次。
另外，epoll内部使用红黑树保存所有fd，确保log(n)的查找效率，使用双向链表保存所有的触发的事件，
epoll_wait只需从链表中查找相应的事件，减少了遍历数组的大小。

epoll代码结构:

```
epoll_create(e)
epoll_ctl(a[]);
while true
{
   epoll_wait()
   foreach(i in b[])
       handle b[i]
}
```

## 3.2 epoll代码实现


# 结束

8月中旬啦，自己的定位基本清楚了，

# 参考
